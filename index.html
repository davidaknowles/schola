<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scholar Explorer</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
      line-height: 1.6;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #0066cc;
      padding-bottom: 10px;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .row {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
    }
    input[type=text], input[type=email] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 15px;
      box-sizing: border-box;
    }
    .btn {
      background: #0066cc;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn:hover {
      background: #004f99;
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .controls {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    select {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
    }
    .publication {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.3s;
    }
    .publication:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .title {
      font-size: 18px;
      font-weight: 600;
      color: #0066cc;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .title:hover {
      text-decoration: underline;
    }
    .authors {
      color: #555;
      margin-bottom: 5px;
      font-size: 14px;
    }
    .meta {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
    }
    .journal {
      font-style: italic;
    }
    .metrics {
      display: flex;
      gap: 20px;
      margin-bottom: 10px;
      font-size: 14px;
      flex-wrap: wrap;
    }
    .metric {
      background: #f0f7ff;
      padding: 5px 10px;
      border-radius: 4px;
      border-left: 3px solid #0066cc;
    }
    .metric strong {
      color: #0066cc;
    }
    .abstract {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f9f9f9;
      border-left: 4px solid #0066cc;
      border-radius: 4px;
      color: #444;
      font-size: 14px;
    }
    .abstract.show {
      display: block;
    }
    .links {
      margin-top: 10px;
    }
    .link {
      display: inline-block;
      margin-right: 15px;
      color: #0066cc;
      text-decoration: none;
      font-size: 14px;
    }
    .link:hover {
      text-decoration: underline;
    }
    .summary {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      font-size: 14px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 16px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0066cc;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: #fee;
      border-left: 4px solid #c00;
      padding: 15px;
      margin: 20px 0;
      border-radius: 4px;
      color: #c00;
    }
    .rcr-badge {
      background: #ffd24d;
      color: #5a4300;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    #searchForm, #results {
      display: none;
    }
    #searchForm.show, #results.show {
      display: block;
    }
    footer {
      margin-top: 40px;
      text-align: center;
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>Scholar Explorer</h1>

  <div id="searchForm" class="card show">
    <form id="pubForm">
      <div class="row">
        <label for="author">Author (e.g., Knowles DA)</label>
        <input id="author" name="author" type="text" required placeholder="LastName Initials">
      </div>
      <div class="row">
        <label for="email">Email (for NCBI Entrez)</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" value="scholar@example.com">
      </div>
      <div class="row">
        <label for="start_year">Start Year (optional)</label>
        <input id="start_year" name="start_year" type="text" pattern="[0-9]{4}" placeholder="2018">
      </div>
      <div class="row">
        <label for="end_year">End Year (optional)</label>
        <input id="end_year" name="end_year" type="text" pattern="[0-9]{4}" placeholder="2025">
      </div>
      <div class="row">
        <label>
          <input id="filter_position" name="filter_position" type="checkbox" checked>
          Only include papers where author is in first 2 or last 2 positions
        </label>
      </div>
      <button class="btn" type="submit" id="submitBtn">Fetch Publications</button>
    </form>
  </div>

  <div id="loading" style="display:none;">
    <div class="spinner"></div>
    <p class="loading">Fetching publications...</p>
  </div>

  <div id="error" style="display:none;"></div>

  <div id="results">
    <p><a href="#" id="newSearch" style="color:#0066cc;">&larr; New Search</a></p>
    <div id="summary" class="summary"></div>
    <div class="controls">
      <label for="sortBy">Sort by:</label>
      <select id="sortBy">
        <option value="year">Year (newest first)</option>
        <option value="citations">Citations (most cited first)</option>
        <option value="rcr" selected>RCR (highest first)</option>
      </select>
    </div>
    <div id="publications"></div>
  </div>

  <footer>
    Data from PubMed & NIH iCite. RCR values may be imputed where unavailable.
  </footer>

  <script>
    let allPublications = [];
    let currentAuthor = '';

    document.getElementById('pubForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const author = document.getElementById('author').value.trim();
      const email = document.getElementById('email').value.trim() || 'scholar@example.com';
      const startYear = document.getElementById('start_year').value.trim();
      const endYear = document.getElementById('end_year').value.trim();
      const filterPosition = document.getElementById('filter_position').checked;
      
      if (!author) return;
      
      currentAuthor = author;
      showLoading();
      
      try {
        const pubs = await fetchPublications(author, email, startYear, endYear, filterPosition);
        displayResults(pubs, author);
      } catch (err) {
        showError(err.message);
      }
    });

    document.getElementById('newSearch').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('searchForm').classList.add('show');
      document.getElementById('results').classList.remove('show');
    });

    document.getElementById('sortBy').addEventListener('change', () => {
      sortPublications();
    });

    function showLoading() {
      document.getElementById('searchForm').classList.remove('show');
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error').style.display = 'none';
      document.getElementById('results').classList.remove('show');
    }

    function showError(message) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
      document.getElementById('error').innerHTML = `<div class="error">Error: ${message}</div>`;
    }

    function showResults() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'none';
      document.getElementById('results').classList.add('show');
    }

    async function fetchPublications(author, email, startYear, endYear, filterPosition) {
      // Build search term
      let term = `${author}[Author]`;
      if (startYear || endYear) {
        const start = startYear || '1900';
        const end = endYear || '3000';
        term += ` AND ("${start}"[dp] : "${end}"[dp])`;
      }

      // Search PubMed
      const searchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed&term=${encodeURIComponent(term)}&retmax=10000&retmode=json&tool=scholar_explorer&email=${encodeURIComponent(email)}`;
      
      const searchResp = await fetch(searchUrl);
      const searchData = await searchResp.json();
      const ids = searchData.esearchresult.idlist;

      if (!ids || ids.length === 0) {
        throw new Error('No publications found');
      }

      // Fetch publication details in batches
      const publications = [];
      const batchSize = 100;
      const searchLastName = author.split(/\s+/)[0].toUpperCase();

      for (let i = 0; i < ids.length; i += batchSize) {
        const batchIds = ids.slice(i, i + batchSize);
        const fetchUrl = `https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed&id=${batchIds.join(',')}&retmode=xml&tool=scholar_explorer&email=${encodeURIComponent(email)}`;
        
        const fetchResp = await fetch(fetchUrl);
        const xmlText = await fetchResp.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        const articles = xmlDoc.querySelectorAll('PubmedArticle');
        
        articles.forEach(article => {
          try {
            const pub = parseArticle(article, searchLastName, filterPosition);
            if (pub) {
              publications.push(pub);
            }
          } catch (e) {
            console.error('Error parsing article:', e);
          }
        });

        // Rate limit
        await new Promise(resolve => setTimeout(resolve, 350));
      }

      // Fetch citation data
      if (publications.length > 0) {
        await fetchCitations(publications);
      }

      // Compute imputed RCR
      computeImputedMetrics(publications);

      return publications;
    }

    function parseArticle(article, searchLastName, filterPosition) {
      const medlineCitation = article.querySelector('MedlineCitation');
      const articleElem = medlineCitation.querySelector('Article');
      
      // PMID
      const pmid = medlineCitation.querySelector('PMID')?.textContent || '';
      
      // Title
      const title = articleElem.querySelector('ArticleTitle')?.textContent || 'No title';
      
      // Authors
      const authorList = articleElem.querySelectorAll('Author');
      const authors = [];
      let authorPosition = -1;
      
      authorList.forEach((author, idx) => {
        const lastName = author.querySelector('LastName')?.textContent;
        const initials = author.querySelector('Initials')?.textContent;
        const collectiveName = author.querySelector('CollectiveName')?.textContent;
        
        if (lastName && initials) {
          authors.push(`${lastName} ${initials}`);
          if (lastName.toUpperCase() === searchLastName) {
            authorPosition = idx;
          }
        } else if (collectiveName) {
          authors.push(collectiveName);
        }
      });

      // Filter by author position if enabled
      if (filterPosition) {
        if (authorPosition === -1) return null; // Author not found
        const numAuthors = authors.length;
        const isFirstTwo = authorPosition < 2;
        const isLastTwo = authorPosition >= numAuthors - 2;
        if (!isFirstTwo && !isLastTwo) return null;
      }

      // Year
      const pubDate = articleElem.querySelector('PubDate');
      let year = pubDate?.querySelector('Year')?.textContent || '';
      if (!year) {
        const medlineDate = pubDate?.querySelector('MedlineDate')?.textContent || '';
        year = medlineDate.split(/\s+/)[0] || '';
      }

      // Journal
      const journal = articleElem.querySelector('Journal Title')?.textContent || '';

      // DOI
      let doi = '';
      const articleIds = article.querySelectorAll('ArticleId');
      articleIds.forEach(id => {
        if (id.getAttribute('IdType') === 'doi') {
          doi = id.textContent;
        }
      });

      // Abstract
      const abstractTexts = articleElem.querySelectorAll('AbstractText');
      let abstract = '';
      if (abstractTexts.length > 0) {
        abstract = Array.from(abstractTexts).map(t => t.textContent).join(' ');
      }

      return {
        PMID: pmid,
        Title: title,
        Authors: authors.join(', '),
        Journal: journal,
        Year: year,
        DOI: doi,
        Abstract: abstract || 'No abstract available',
        PubMed_URL: `https://pubmed.ncbi.nlm.nih.gov/${pmid}/`,
        Citation_Count: 0,
        RCR: '',
        RCR_imputed: 0
      };
    }

    async function fetchCitations(publications) {
      const batchSize = 1000;
      const pmids = publications.map(p => p.PMID);

      for (let i = 0; i < pmids.length; i += batchSize) {
        const batchPmids = pmids.slice(i, i + batchSize);
        const url = `https://icite.od.nih.gov/api/pubs?pmids=${batchPmids.join(',')}&format=json`;

        try {
          const resp = await fetch(url);
          const data = await resp.json();
          
          const citationMap = {};
          (data.data || []).forEach(item => {
            citationMap[item.pmid] = {
              citation_count: item.citation_count || 0,
              rcr: item.relative_citation_ratio || ''
            };
          });

          publications.forEach(pub => {
            if (citationMap[pub.PMID]) {
              pub.Citation_Count = citationMap[pub.PMID].citation_count;
              pub.RCR = citationMap[pub.PMID].rcr;
            }
          });

          await new Promise(resolve => setTimeout(resolve, 500));
        } catch (e) {
          console.error('Error fetching citations:', e);
        }
      }
    }

    function computeImputedMetrics(publications) {
      const currentYear = new Date().getFullYear();
      
      publications.forEach(pub => {
        if (!pub.RCR || pub.RCR === '') {
          const year = parseInt(pub.Year) || currentYear;
          const citations = parseInt(pub.Citation_Count) || 0;
          const yearsSince = currentYear - year;
          
          if (yearsSince > 0) {
            pub.RCR_imputed = citations / yearsSince;
          } else {
            pub.RCR_imputed = citations + 1;
          }
        } else {
          pub.RCR_imputed = parseFloat(pub.RCR);
        }
      });
    }

    function displayResults(publications, author) {
      allPublications = publications;
      
      // Summary
      const totalCitations = publications.reduce((sum, p) => sum + (parseInt(p.Citation_Count) || 0), 0);
      document.getElementById('summary').innerHTML = `
        <strong>Total Publications:</strong> ${publications.length} |
        <strong>Total Citations:</strong> ${totalCitations}
      `;

      // Render publications
      renderPublications(publications, author);
      
      // Sort by RCR by default
      document.getElementById('sortBy').value = 'rcr';
      sortPublications();
      
      showResults();
    }

    function renderPublications(publications, author) {
      const container = document.getElementById('publications');
      const searchParts = author.split(/\s+/);
      const searchLast = (searchParts[0] || '').toLowerCase();
      const searchInitials = (searchParts.slice(1).join('') || '').toLowerCase();

      container.innerHTML = publications.map((pub, idx) => {
        const year = pub.Year || 'N/A';
        const citations = pub.Citation_Count || 0;
        const rcrImputed = pub.RCR_imputed || 0;
        const rcrRaw = pub.RCR;
        const displayRCR = rcrRaw ? parseFloat(rcrRaw).toFixed(2) : rcrImputed.toFixed(2);
        const isImputed = !rcrRaw || rcrRaw === '';

        // Highlight author
        const authorsHighlighted = pub.Authors.split(', ').map(a => {
          const parts = a.split(/\s+/);
          const last = (parts[0] || '').toLowerCase();
          const initials = (parts.slice(1).join('') || '').toLowerCase();
          if (last === searchLast && (!searchInitials || initials.startsWith(searchInitials))) {
            return `<strong>${a}</strong>`;
          }
          return a;
        }).join(', ');

        return `
          <div class="publication" data-year="${year}" data-citations="${citations}" data-rcr="${rcrImputed}">
            <div class="title" onclick="toggleAbstract(${idx})">${pub.Title}</div>
            <div class="authors">${authorsHighlighted}</div>
            <div class="meta"><span class="journal">${pub.Journal}</span> (${year})</div>
            <div class="metrics">
              <div class="metric"><strong>Citations:</strong> ${citations}</div>
              <div class="metric"><strong>RCR:</strong> ${displayRCR}${isImputed ? '<span class="rcr-badge" title="Imputed from citations/time">IMPUTED</span>' : ''}</div>
            </div>
            <div class="links">
              <a class="link" href="${pub.PubMed_URL}" target="_blank">ðŸ“„ PubMed</a>
              ${pub.DOI ? `<a class="link" href="https://doi.org/${pub.DOI}" target="_blank">ðŸ”— DOI</a>` : ''}
              <a class="link" href="#" onclick="toggleAbstract(${idx}); return false;">ðŸ“– Abstract</a>
            </div>
            <div class="abstract" id="abstract-${idx}">
              <strong>Abstract:</strong><br>${pub.Abstract}
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleAbstract(id) {
      const el = document.getElementById(`abstract-${id}`);
      if (el) {
        el.classList.toggle('show');
      }
    }

    function sortPublications() {
      const sortBy = document.getElementById('sortBy').value;
      const container = document.getElementById('publications');
      const pubs = Array.from(container.getElementsByClassName('publication'));

      pubs.sort((a, b) => {
        let aVal, bVal;
        
        if (sortBy === 'year') {
          aVal = parseInt(a.getAttribute('data-year')) || 0;
          bVal = parseInt(b.getAttribute('data-year')) || 0;
          return bVal - aVal;
        } else if (sortBy === 'citations') {
          aVal = parseInt(a.getAttribute('data-citations')) || 0;
          bVal = parseInt(b.getAttribute('data-citations')) || 0;
          return bVal - aVal;
        } else if (sortBy === 'rcr') {
          aVal = parseFloat(a.getAttribute('data-rcr')) || 0;
          bVal = parseFloat(b.getAttribute('data-rcr')) || 0;
          return bVal - aVal;
        }
        return 0;
      });

      container.innerHTML = '';
      pubs.forEach(pub => container.appendChild(pub));
    }
  </script>
</body>
</html>
